repeat task.wait() until game:IsLoaded()

------------------------------------------------
-- CONFIG URL
------------------------------------------------
-- URL nÃ y pháº£i chuáº©n xÃ¡c, náº¿u link die thÃ¬ auto load sáº½ táº¡ch
local SCRIPT_URL = "https://raw.githubusercontent.com/huynhphutoan1908-dev/BustupidHub/main/BustupidHub.lua"

------------------------------------------------
-- LOAD UI
------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

------------------------------------------------
-- SERVICES
------------------------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

------------------------------------------------
-- AUTOSAVE SYSTEM
------------------------------------------------
local SAVE_FILE = "BustupidHub_Save.json"

local SaveData = {
	autoXYZ = false,
	autoTimeTP = false,
	autoPlayerTP = false,
	autoSafeHop = false,    
	autoTimeHop = false,    
	autoTPObbyTime = false, 
	hopDelay = 8,
	autoLoad = true
}

if isfile(SAVE_FILE) then
	pcall(function()
		local readData = HttpService:JSONDecode(readfile(SAVE_FILE))
		for k,v in pairs(readData) do
			if SaveData[k] ~= nil then
				SaveData[k] = v
			end
		end
	end)
end

local function Save()
	writefile(SAVE_FILE, HttpService:JSONEncode(SaveData))
end

------------------------------------------------
-- QUEUE AUTOLOAD (FIXED & STRONG)
------------------------------------------------
local function QueueAutoLoad()
	if not SaveData.autoLoad then return end
	
	-- NhÃºng trá»±c tiáº¿p URL vÃ o chuá»—i code Ä‘á»ƒ trÃ¡nh lá»—i biáº¿n
	local nextServerCode = [[
		task.wait(3) -- Chá» 3s Ä‘á»ƒ game load cÃ¡c module cáº§n thiáº¿t
		repeat task.wait() until game:IsLoaded()
		pcall(function()
			loadstring(game:HttpGet("]] .. SCRIPT_URL .. [["))()
		end)
	]]
	
	-- Há»— trá»£ nhiá»u loáº¡i Executor hÆ¡n
	local queueFunc = queue_on_teleport or (syn and syn.queue_on_teleport) or (fluxus and fluxus.queue_on_teleport)
	
	if queueFunc then
		queueFunc(nextServerCode)
	else
		-- Náº¿u executor quÃ¡ cÃ¹i báº¯p khÃ´ng cÃ³ hÃ m nÃ y
		warn("Executor cá»§a báº¡n khÃ´ng há»— trá»£ Queue Auto Load!")
	end
end

------------------------------------------------
-- CONFIG VARIABLES
------------------------------------------------
local TARGET_POS = Vector3.new(910, -16.7, -526)
local TARGET_MINUTE = 5
local TELEPORT_TIMES = 10

------------------------------------------------
-- STATE VARIABLES
------------------------------------------------
local autoXYZ = SaveData.autoXYZ
local autoTimeTP = SaveData.autoTimeTP
local autoPlayerTP = SaveData.autoPlayerTP
local autoSafeHop = SaveData.autoSafeHop
local autoTimeHop = SaveData.autoTimeHop 
local autoTPObbyTime = SaveData.autoTPObbyTime
local hopDelay = SaveData.hopDelay

local targetPlayer = nil
local lastHour = -1
local inputServerId = ""
local isHopping = false 

------------------------------------------------
-- SAFE HOP LOGIC
------------------------------------------------
local function safeHop()
	if isHopping then return end 
	isHopping = true

	Save() 
	QueueAutoLoad() -- Gá»i hÃ m queue trÆ°á»›c khi tele

	Rayfield:Notify({
		Title = "ğŸ›¡ï¸ Safe Hop",
		Content = "Äang tÃ¬m server khÃ¡c...",
		Duration = 3
	})
	
	task.wait(1.5)

	local PlaceID = game.PlaceId
	local foundAnything = ""
	
	local function TPReturner()
		local Site;
		local success, result = pcall(function()
			return game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100' .. (foundAnything ~= "" and ("&cursor=" .. foundAnything) or ""))
		end)

		if not success then return end
		
		Site = HttpService:JSONDecode(result)
		
		if Site.nextPageCursor and Site.nextPageCursor ~= "null" then
			foundAnything = Site.nextPageCursor
		end
		
		for i,v in pairs(Site.data) do
			local ID = tostring(v.id)
			if tonumber(v.maxPlayers) > tonumber(v.playing) and ID ~= game.JobId then
				Rayfield:Notify({Title = "Found Server", Content = "Äang káº¿t ná»‘i...", Duration = 2})
				task.wait(math.random(10, 20) / 10)
				TeleportService:TeleportToPlaceInstance(PlaceID, ID, LocalPlayer)
				task.wait(30) 
			end
		end
	end

	pcall(function()
		TPReturner()
		if foundAnything ~= "" then
			TPReturner()
		end
	end)
	
	Rayfield:Notify({Title = "KhÃ´ng tÃ¬m tháº¥y", Content = "Rejoin server ngáº«u nhiÃªn...", Duration = 2})
	TeleportService:Teleport(game.PlaceId, LocalPlayer)
	
	task.wait(5)
	isHopping = false 
end

------------------------------------------------
-- WINDOW UI
------------------------------------------------
local Window = Rayfield:CreateWindow({
	Name = "Bustupid Hub",
	LoadingTitle = "Bustupid Hub",
	LoadingSubtitle = "FIXED QUEUE LOAD",
	KeySystem = false
})

------------------------------------------------
-- TAB EVENT
------------------------------------------------
local TeleTab = Window:CreateTab("Event", 4483362458)

TeleTab:CreateSection("Teleport Tools")

TeleTab:CreateButton({
	Name = "Teleport XYZ Ngay",
	Callback = function()
		if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
			LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(TARGET_POS)
		end
	end
})

TeleTab:CreateButton({
	Name = "LÆ°u Vá»‹ TrÃ­ Hiá»‡n Táº¡i lÃ m XYZ",
	Callback = function()
		if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
			TARGET_POS = LocalPlayer.Character.HumanoidRootPart.Position
			Rayfield:Notify({Title = "Updated", Content = "ÄÃ£ cáº­p nháº­t tá»a Ä‘á»™ má»›i!", Duration = 2})
		end
	end
})

TeleTab:CreateToggle({
	Name = "Auto Teleport XYZ (LuÃ´n luÃ´n)",
	CurrentValue = autoXYZ,
	Callback = function(v)
		autoXYZ = v
		SaveData.autoXYZ = v
		Save()
	end
})

TeleTab:CreateSection("Auto Time Features")

TeleTab:CreateToggle({
	Name = "Auto TP xx:05 (Má»—i tiáº¿ng 1 láº§n)",
	CurrentValue = autoTimeTP,
	Callback = function(v)
		autoTimeTP = v
		SaveData.autoTimeTP = v
		Save()
	end
})

TeleTab:CreateToggle({
	Name = "Auto TP Event Obby (05-10p)",
	CurrentValue = autoTPObbyTime,
	Callback = function(v)
		autoTPObbyTime = v
		SaveData.autoTPObbyTime = v
		Save()
	end
})

TeleTab:CreateToggle({
	Name = "Auto Hop (PhÃºt 05-10)",
	CurrentValue = autoTimeHop,
	Callback = function(v)
		autoTimeHop = v
		SaveData.autoTimeHop = v
		Save()
	end
})

------------------------------------------------
-- TAB COMBAT
------------------------------------------------
local CombatTab = Window:CreateTab("Combat", 4483362458)

local function getPlayers()
	local t = {}
	for _,p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			table.insert(t,p.Name)
		end
	end
	return t
end

local dropdown = CombatTab:CreateDropdown({
	Name = "Chá»n Player",
	Options = getPlayers(),
	Callback = function(v)
		if v and v[1] then
			targetPlayer = Players:FindFirstChild(v[1])
		end
	end
})

CombatTab:CreateButton({
	Name = "Refresh Player",
	Callback = function()
		dropdown:Refresh(getPlayers())
	end
})

CombatTab:CreateToggle({
	Name = "Auto TP Sau LÆ°ng",
	CurrentValue = autoPlayerTP,
	Callback = function(v)
		autoPlayerTP = v
		SaveData.autoPlayerTP = v
		Save()
	end
})

------------------------------------------------
-- TAB SERVER
------------------------------------------------
local ServerTab = Window:CreateTab("Server", 4483362458)

ServerTab:CreateButton({
	Name = "Rejoin Server",
	Callback = function()
		QueueAutoLoad()
		TeleportService:Teleport(game.PlaceId, LocalPlayer)
	end
})

ServerTab:CreateButton({
	Name = "Copy Server ID",
	Callback = function()
		setclipboard(game.JobId)
	end
})

ServerTab:CreateInput({
	Name = "Server ID",
	PlaceholderText = "DÃ¡n JobId",
	RemoveTextAfterFocusLost = false,
	Callback = function(v)
		inputServerId = v
	end
})

ServerTab:CreateButton({
	Name = "Join Server ID",
	Callback = function()
		if inputServerId ~= "" then
			QueueAutoLoad()
			TeleportService:TeleportToPlaceInstance(
				game.PlaceId,
				inputServerId,
				LocalPlayer
			)
		end
	end
})

ServerTab:CreateToggle({
	Name = "Auto Hop (ThÆ°á»ng)",
	CurrentValue = autoSafeHop,
	Callback = function(v)
		autoSafeHop = v
		SaveData.autoSafeHop = v
		Save()
	end
})

ServerTab:CreateInput({
	Name = "Hop Delay (giÃ¢y)",
	PlaceholderText = tostring(hopDelay),
	RemoveTextAfterFocusLost = false,
	Callback = function(v)
		hopDelay = tonumber(v) or hopDelay
		SaveData.hopDelay = hopDelay
		Save()
	end
})

------------------------------------------------
-- TAB MISC
------------------------------------------------
local MiscTab = Window:CreateTab("Misc", 4483362458)

MiscTab:CreateToggle({
	Name = "Auto Load Khi Hop",
	CurrentValue = SaveData.autoLoad,
	Callback = function(v)
		SaveData.autoLoad = v
		Save()
	end
})

------------------------------------------------
-- AUTO FEATURES (LOOPS)
------------------------------------------------

task.spawn(function()
	while task.wait(0.1) do
		if autoXYZ then
			pcall(function()
				if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
					LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(TARGET_POS)
				end
			end)
		end
	end
end)

task.spawn(function()
	while task.wait(1) do
		if autoTimeTP then
			local t = os.date("*t")
			if t.min == TARGET_MINUTE and t.hour ~= lastHour then
				lastHour = t.hour
				for i=1, TELEPORT_TIMES do
					pcall(function()
						LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(TARGET_POS)
					end)
					task.wait(1)
				end
			end
		end
	end
end)

task.spawn(function()
	while task.wait(0.2) do 
		if autoTPObbyTime then
			local t = os.date("*t")
			if t.min >= 5 and t.min <= 10 then
				pcall(function()
					if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
						LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(910, -16.7, -526)
					end
				end)
			end
		end
	end
end)

RunService.Heartbeat:Connect(function()
	if autoPlayerTP and targetPlayer and targetPlayer.Character then
		local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		local thrp = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
		if hrp and thrp then
			hrp.CFrame = thrp.CFrame * CFrame.new(0,0,-2)
		end
	end
end)

task.spawn(function()
	while task.wait(hopDelay) do
		if autoSafeHop and not isHopping then
			safeHop()
		end
	end
end)

task.spawn(function()
	while task.wait(5) do 
		if autoTimeHop then
			local t = os.date("*t")
			if t.min >= 5 and t.min <= 10 then
				if not isHopping then
					Rayfield:Notify({
						Title = "â° Time Hop",
						Content = "Äáº¿n giá» sÄƒn Event (05-10)!",
						Duration = 3
					})
					safeHop()
					task.wait(60) 
				end
			else
				if t.min > 10 then isHopping = false end
			end
		end
	end
end)
