repeat task.wait() until game:IsLoaded()

------------------------------------------------
-- [ENGLISH EDITION] BUSTUPID HUB | by HuynhToann
------------------------------------------------
local SCRIPT_URL = "https://raw.githubusercontent.com/huynhphutoan1908-dev/BustupidHub/refs/heads/main/BustupidHub"

------------------------------------------------
-- SERVICES
------------------------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

------------------------------------------------
-- UI LOAD
------------------------------------------------
local success, Rayfield = pcall(function()
    return loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
end)

if not success then return end

------------------------------------------------
-- CONFIG & SAVE
------------------------------------------------
local SAVE_FILE = "BustupidHub_Combat.json" -- Äá»•i tÃªn file save má»›i

local SaveData = {
    autoXYZ = false,
    autoTimeTP = false,
    autoPlayerTP = false,
    autoAttack = false, -- [NEW] LÆ°u tráº¡ng thÃ¡i Auto Attack
    autoSafeHop = false,
    autoTimeHop = false,    
    autoTPObbyTime = false, 
    autoAntiAFK = true,
    hopDelay = 10, 
    autoLoad = true
}

if isfile(SAVE_FILE) then
    pcall(function()
        local readData = HttpService:JSONDecode(readfile(SAVE_FILE))
        for k,v in pairs(readData) do
            if SaveData[k] ~= nil then SaveData[k] = v end
        end
    end)
end

-- FORCE OFF (Safety)
SaveData.autoXYZ = false
SaveData.autoTPObbyTime = false
SaveData.autoTimeTP = false
-- SaveData.autoAttack = false -- CÃ³ thá»ƒ bá» comment dÃ²ng nÃ y náº¿u muá»‘n táº¯t Auto Attack má»—i khi vÃ o game

local function Save()
    writefile(SAVE_FILE, HttpService:JSONEncode(SaveData))
end

local function QueueAutoLoad()
    if not SaveData.autoLoad then return end
    local nextCode = [[
        task.wait(5)
        repeat task.wait() until game:IsLoaded()
        pcall(function() loadstring(game:HttpGet("]] .. SCRIPT_URL .. [["))() end)
    ]]
    if queue_on_teleport then queue_on_teleport(nextCode)
    elseif syn and syn.queue_on_teleport then syn.queue_on_teleport(nextCode)
    elseif fluxus and fluxus.queue_on_teleport then fluxus.queue_on_teleport(nextCode) end
end

------------------------------------------------
-- VARIABLES
------------------------------------------------
local TARGET_POS = Vector3.new(910, -16.7, -526)
local TARGET_CFRAME = CFrame.new(910, -16.7, -526)
local TARGET_MINUTE = 5 
local TELEPORT_TIMES = 10

local autoXYZ = false
local autoTimeTP = false
local autoPlayerTP = SaveData.autoPlayerTP
local autoAttack = SaveData.autoAttack -- [NEW]
local autoSafeHop = SaveData.autoSafeHop
local autoTimeHop = SaveData.autoTimeHop 
local autoTPObbyTime = false
local autoAntiAFK = SaveData.autoAntiAFK
local hopDelay = SaveData.hopDelay

local targetPlayer = nil
local lastHour = -1
local inputServerId = ""
local isHopping = false 
local failCount = 0
local lastHopTime = 0 
local lastAFKAction = 0
local shared_IsEventTime = false 

------------------------------------------------
-- SAFE HOP V2 (ANTI-CRASH LOGIC)
------------------------------------------------
local safeHop 

TeleportService.TeleportInitFailed:Connect(function(player, result, errorMessage)
    if player == LocalPlayer then
        warn("TP Fail: " .. tostring(errorMessage))
        task.wait(3) 
        
        if isHopping or autoSafeHop or autoTimeHop then
            failCount = failCount + 1
            isHopping = false
            
            if failCount > 2 then
                failCount = 0
                Rayfield:Notify({Title = "âš ï¸ Crash Prevent", Content = "Rejoining to prevent crash...", Duration = 3})
                TeleportService:Teleport(game.PlaceId, LocalPlayer) 
            else
                safeHop()
            end
        end
    end
end)

safeHop = function()
    if isHopping then return end 
    isHopping = true
    Save()
    QueueAutoLoad()

    Rayfield:Notify({Title = "ðŸ›¡ï¸ Safe Hop", Content = "Scanning (Safe Mode)...", Duration = 2})
    
    local PlaceID = game.PlaceId
    local foundAnything = ""
    local validServers = {} 
    
    local function FetchServers()
        local Site;
        local success, result = pcall(function()
            return game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100' .. (foundAnything ~= "" and ("&cursor=" .. foundAnything) or ""))
        end)
        
        if not success then 
            warn("HTTP Error: Rate Limit")
            return false 
        end
        
        Site = HttpService:JSONDecode(result)
        if Site.nextPageCursor and Site.nextPageCursor ~= "null" then foundAnything = Site.nextPageCursor end
        
        for i,v in pairs(Site.data) do
            local ID = tostring(v.id)
            local max = tonumber(v.maxPlayers)
            local playing = tonumber(v.playing)
            if (max - playing >= 2) and ID ~= game.JobId then
                table.insert(validServers, ID)
            end
        end
        return true
    end

    pcall(function() 
        local try1 = FetchServers()
        if not try1 then task.wait(2) end 
        
        if foundAnything ~= "" then 
            task.wait(0.5)
            FetchServers() 
        end 
    end)
    
    if #validServers > 0 then
        local randomID = validServers[math.random(1, #validServers)]
        task.wait(math.random(15, 30) / 10) 
        TeleportService:TeleportToPlaceInstance(PlaceID, randomID, LocalPlayer)
        task.delay(30, function() if isHopping then isHopping = false end end)
    else
        Rayfield:Notify({Title = "No Server", Content = "Rejoining...", Duration = 2})
        task.wait(1)
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
        isHopping = false
    end
end

-- Anti-AFK Function
local function PerformAntiAFK()
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new()) 
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.Jump = true
        end
    end)
end

------------------------------------------------
-- LOOPS
------------------------------------------------

-- SLOW LOOP (1s)
task.spawn(function()
    while task.wait(1) do
        local t = os.date("*t")
        
        -- 1. Check Event (00-10)
        if t.min >= 0 and t.min <= 10 then
            shared_IsEventTime = true
        else
            shared_IsEventTime = false
            if isHopping and autoTimeHop and t.min == 11 then isHopping = false end
        end

        -- 2. Anti-AFK (3 mins/time)
        if autoAntiAFK and (tick() - lastAFKAction > 180) then
            lastAFKAction = tick()
            PerformAntiAFK()
        end

        -- 3. Auto TP xx:05
        if autoTimeTP and t.min == 5 and t.hour ~= lastHour then
            lastHour = t.hour
            task.spawn(function()
                for i=1, TELEPORT_TIMES do
                    pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(TARGET_POS) end)
                    task.wait(1)
                end
            end)
        end

        -- 4. Auto Hop Event
        if autoTimeHop and shared_IsEventTime and not isHopping then
             Rayfield:Notify({Title = "â° Event (00-10)", Content = "Finding server...", Duration = 3})
             safeHop()
             task.wait(60) 
        end

        -- 5. Auto Hop Normal
        if autoSafeHop and not isHopping then
            if tick() - lastHopTime >= hopDelay then
                lastHopTime = tick()
                safeHop()
            end
        end
    end
end)

-- FAST LOOP (0.2s)
task.spawn(function()
    while task.wait(0.2) do
        if autoXYZ then
            pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = TARGET_CFRAME end)
        elseif autoTPObbyTime and shared_IsEventTime then
            pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = TARGET_CFRAME end)
        end
    end
end)

-- [NEW] AUTO ATTACK LOOP (0.1s - Fast)
task.spawn(function()
    while task.wait(0.1) do
        if autoAttack then
            pcall(function()
                -- CÃ¡ch 1: KÃ­ch hoáº¡t Tool (VÅ© khÃ­)
                local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
                if tool then
                    tool:Activate()
                end
                
                -- CÃ¡ch 2: Click chuá»™t áº£o (DÃ nh cho game khÃ´ng dÃ¹ng Tool)
                VirtualUser:CaptureController()
                VirtualUser:ClickButton1(Vector2.new())
            end)
        end
    end
end)

-- COMBAT LOOP (TP BEHIND)
RunService.Heartbeat:Connect(function()
    if autoPlayerTP and targetPlayer and targetPlayer.Character then
        local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local thrp = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        if hrp and thrp then hrp.CFrame = thrp.CFrame * CFrame.new(0,0,-2) end
    end
end)

-- PASSIVE ANTI-AFK
LocalPlayer.Idled:Connect(function()
    if autoAntiAFK then PerformAntiAFK() end
end)

------------------------------------------------
-- UI SETUP
------------------------------------------------
local Window = Rayfield:CreateWindow({
    Name = "Bustupid Hub | by HuynhToann",
    LoadingTitle = "ANTI-CRASH + AUTO ATTACK",
    LoadingSubtitle = "by HuynhToann",
    KeySystem = false
})

local TeleTab = Window:CreateTab("Event", 4483362458)
TeleTab:CreateSection("Auto Event Config")
TeleTab:CreateToggle({Name = "Auto TP Event Obby (00-10m)", CurrentValue = false, Callback = function(v) autoTPObbyTime = v end})
TeleTab:CreateToggle({Name = "Auto Hop (00-10m)", CurrentValue = autoTimeHop, Callback = function(v) autoTimeHop = v; SaveData.autoTimeHop = v; Save() end})

TeleTab:CreateSection("Teleport Config")
TeleTab:CreateButton({Name = "Teleport XYZ Now", Callback = function() pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = TARGET_CFRAME end) end})
TeleTab:CreateToggle({Name = "Auto Teleport XYZ (AFK)", CurrentValue = autoXYZ, Callback = function(v) autoXYZ = v end})

TeleTab:CreateSection("Time Config")
TeleTab:CreateToggle({Name = "Auto TP xx:05 (Hourly)", CurrentValue = false, Callback = function(v) autoTimeTP = v end})

local CombatTab = Window:CreateTab("Combat", 4483362458)
local function getPlayers() local t = {}; for _,p in pairs(Players:GetPlayers()) do if p ~= LocalPlayer then table.insert(t,p.Name) end end; return t end
local dropdown = CombatTab:CreateDropdown({Name = "Select Player", Options = getPlayers(), Callback = function(v) if v and v[1] then targetPlayer = Players:FindFirstChild(v[1]) end end})
CombatTab:CreateButton({Name = "Refresh Player", Callback = function() dropdown:Refresh(getPlayers()) end})
CombatTab:CreateToggle({Name = "Auto TP Behind", CurrentValue = autoPlayerTP, Callback = function(v) autoPlayerTP = v; SaveData.autoPlayerTP = v; Save() end})

-- [NEW] AUTO ATTACK TOGGLE
CombatTab:CreateToggle({
    Name = "Auto Attack (Fast)",
    CurrentValue = autoAttack,
    Callback = function(v)
        autoAttack = v
        SaveData.autoAttack = v
        Save()
    end
})

local ServerTab = Window:CreateTab("Server", 4483362458)
ServerTab:CreateButton({Name = "Rejoin Server", Callback = function() QueueAutoLoad(); TeleportService:Teleport(game.PlaceId, LocalPlayer) end})
ServerTab:CreateButton({Name = "Copy Server ID", Callback = function() setclipboard(game.JobId) end})
ServerTab:CreateInput({Name = "Server ID", PlaceholderText = "JobId...", RemoveTextAfterFocusLost = false, Callback = function(v) inputServerId = v end})
ServerTab:CreateButton({Name = "Join Server ID", Callback = function() if inputServerId ~= "" then QueueAutoLoad(); TeleportService:TeleportToPlaceInstance(game.PlaceId, inputServerId, LocalPlayer) end end})

ServerTab:CreateToggle({Name = "Auto Hop (Always)", CurrentValue = autoSafeHop, Callback = function(v) autoSafeHop = v; SaveData.autoSafeHop = v; Save() end})
ServerTab:CreateInput({Name = "Hop Delay (s) - Rec: >10s", PlaceholderText = tostring(hopDelay), RemoveTextAfterFocusLost = false, Callback = function(v) hopDelay = tonumber(v) or hopDelay; SaveData.hopDelay = hopDelay; Save() end})

local MiscTab = Window:CreateTab("Misc", 4483362458)
MiscTab:CreateSection("Utilities")
MiscTab:CreateToggle({Name = "Super Anti-AFK (Dual Protection)", CurrentValue = autoAntiAFK, Callback = function(v) autoAntiAFK = v; SaveData.autoAntiAFK = v; Save() end})
MiscTab:CreateToggle({Name = "Auto Load on Hop", CurrentValue = SaveData.autoLoad, Callback = function(v) SaveData.autoLoad = v; Save() end})
